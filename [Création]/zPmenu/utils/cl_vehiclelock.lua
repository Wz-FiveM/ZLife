ESX=nil;local a={}Citizen.CreateThread(function()while ESX==nil do TriggerEvent('esx:getSharedObject',function(b)ESX=b end)Citizen.Wait(1)end end)RegisterNetEvent('esx_menu:key')AddEventHandler('esx_menu:key',function()ESX.TriggerServerCallback('esx_vehiclelock:allkey',function(c)local elements={}for d=1,#c,1 do if c[d].got=='true'then if c[d].NB==1 then table.insert(elements,{label='Clés : '..' ['..c[d].plate..']',value=c[d].plate})elseif c[d].NB==2 then table.insert(elements,{label='[DOUBLE] Véhicule : '..' ['..c[d].plate..']',value=nil})end end end end)end)function openKeysMenu()ESX.UI.Menu.Open('default',GetCurrentResourceName(),'mykey',{css='cle',title='Mes clés',align='top-left',elements=elements},function(e,f)if e.current.value~='nil'then ESX.UI.Menu.CloseAll()ESX.UI.Menu.Open('default',GetCurrentResourceName(),'mykey',{css='cle',title='Voulez vous ?',align='top-left',elements={{label='Donner votre paire de Clé',value='donnerkey'},{label='Préter Clé',value='preterkey'}}},function(g,h)local i,j=ESX.Game.GetClosestPlayer()local k=GetPlayerPed(-1)local l=GetEntityCoords(k,true)local m=GetClosestVehicle(l.x,l.y,l.z,7.0,0,71)local n=ESX.Game.GetVehicleProperties(m)if g.current.value=='donnerkey'then ESX.UI.Menu.CloseAll()if j~=-1 and j<=3.0 then TriggerServerEvent('esx_vehiclelock:donnerkey',GetPlayerServerId(i),e.current.value)TriggerServerEvent('esx_vehiclelock:deletekey',e.current.value)print("avant changement owner")TriggerServerEvent('esx_vehiclelock:changeowner',GetPlayerServerId(i),n)print("après changement owner")end end;if g.current.value=='preterkey'then ESX.UI.Menu.CloseAll()if j~=-1 and j<=3.0 then TriggerServerEvent('esx_vehiclelock:preterkey',GetPlayerServerId(i),e.current.value)end end end,function(g,h)h.close()end,function(g,h)end)end end,function(e,o)o.close()end,function(p,o)end)end;RegisterNetEvent('esx_menu:key')AddEventHandler('esx_menu:key',function()ESX.TriggerServerCallback('esx_vehiclelock:allkey',function(c)local elements={}for d=1,#c,1 do if c[d].got=='true'then if c[d].NB==1 then table.insert(elements,{label='Clés : '..' ['..c[d].plate..']',value=c[d].plate})elseif c[d].NB==2 then table.insert(elements,{label='[DOUBLE] Véhicule : '..' ['..c[d].plate..']',value=nil})end end end;ESX.UI.Menu.Open('default',GetCurrentResourceName(),'mykey',{css='cle',title='Mes clés',align='top-left',elements=elements},function(e,f)if e.current.value~=nil then ESX.UI.Menu.CloseAll()ESX.UI.Menu.Open('default',GetCurrentResourceName(),'mykey',{css='cle',title='Voulez vous ?',align='top-left',elements={{label='Donner votre paire de Clé',value='donnerkey'},{label='Préter',value=e.current.value}}},function(g,h)local i,j=ESX.Game.GetClosestPlayer()if g.current.value~=nil then ESX.UI.Menu.CloseAll()if j~=-1 and j<=3.0 then TriggerServerEvent('esx_vehiclelock:givekey',GetPlayerServerId(i),e.current.value)end end end,function(g,h)h.close()end,function(g,h)end)end end,function(e,o)o.close()end,function(p,o)end)end)end)AddEventHandler('esx_vehiclelock:hasEnteredMarker',function(q)CurrentAction='cle'CurrentActionMsg='cle'CurrentActionData={zone=q}end)AddEventHandler('esx_vehiclelock:hasExitedMarker',function(q)CurrentAction=nil;ESX.UI.Menu.CloseAll()end)local r;function OpenCloseVehicle()local k=GetPlayerPed(-1)local l=GetEntityCoords(k,true)local s="anim@mp_player_intmenu@key_fob@"local t='p_car_keys_01'local m=nil;if IsPedInAnyVehicle(k,false)then m=GetVehiclePedIsIn(k,false)else m=GetClosestVehicle(l.x,l.y,l.z,7.0,0,71)end;ESX.TriggerServerCallback('esx_vehiclelock:mykey',function(u)RequestAnimDict(s)while not HasAnimDictLoaded(s)do Citizen.Wait(100)end;if u then local v=GetVehicleDoorLockStatus(m)if v==1 or v==0 then SetVehicleDoorsLocked(m,2)PlayVehicleDoorCloseSound(m,1)TaskPlayAnim(k,"anim@mp_player_intmenu@key_fob@","fob_click",8.0,8.0,-1,48,1,false,false,false)if r then RemoveNotification(r)end;r=ShowAboveRadarMessage("Vous avez ~r~verrouillé~w~ le véhicule.")SetVehicleLights(m,2)TriggerEvent('persistent-vehicles/update-vehicle', m);PlaySoundFromEntity(-1,"Remote_Control_Fob",m,"PI_Menu_Sounds",true,0)Wait(200)SetVehicleLights(m,0)PlaySoundFromEntity(-1,"Remote_Control_Fob",m,"PI_Menu_Sounds",true,0)Wait(200)SetVehicleLights(m,2)Wait(400)SetVehicleLights(m,0)elseif v==2 then SetVehicleDoorsLocked(m,1)PlayVehicleDoorOpenSound(m,0)TaskPlayAnim(k,"anim@mp_player_intmenu@key_fob@","fob_click",8.0,8.0,-1,48,1,false,false,false)TaskPlayAnim(GetPlayerPed(-1),"anim@mp_player_intmenu@key_fob@","fob_click",8.0,8.0,-1,48,1,false,false,false)if r then RemoveNotification(r)end;r=ShowAboveRadarMessage("Vous avez ~g~déverrouillé~w~ le véhicule.")SetVehicleLights(m,2)TriggerEvent('persistent-vehicles/update-vehicle', m);PlaySoundFromEntity(-1,"Remote_Control_Fob",m,"PI_Menu_Sounds",true,0)Wait(200)SetVehicleLights(m,0)PlaySoundFromEntity(-1,"Remote_Control_Fob",m,"PI_Menu_Sounds",true,0)Wait(200)SetVehicleLights(m,2)Wait(400)SetVehicleLights(m,0)end else ESX.ShowNotification('~r~Aucun véhicule trouvé.')end end,GetVehicleNumberPlateText(m))end;RegisterControlKey("lockcar","Utiliser ses clés","U",function()OpenCloseVehicle()end)RegisterNetEvent('esx_menu:keycardealer')AddEventHandler('esx_menu:keycardealer',function()ESX.TriggerServerCallback('esx_vehiclelock:allkey',function(c)local elements={}for d=1,#c,1 do if c[d].got=='true'then if c[d].NB==3 then table.insert(elements,{label='[PRO] Clés : '..' ['..c[d].plate..']',value=c[d].plate})end end end;ESX.UI.Menu.Open('default',GetCurrentResourceName(),'mykey',{css='cle',title='Clé Pro',align='top-left',elements=elements},function(e,f)if e.current.value~=nil then ESX.UI.Menu.CloseAll()ESX.UI.Menu.Open('default',GetCurrentResourceName(),'mykey',{css='cle',title='Voulez vous ?',align='top-left',elements={{label='Donner',value=e.current.value}}},function(g,h)local i,j=ESX.Game.GetClosestPlayer()if g.current.value~=nil then ESX.UI.Menu.CloseAll()if j~=-1 and j<=3.0 then TriggerServerEvent('esx_vehiclelock:givekeycardealer',GetPlayerServerId(i),e.current.value)TriggerServerEvent('esx_vehiclelock:deletekeycardealer',GetPlayerServerId(i),e.current.value)end end end,function(g,h)h.close()end,function(g,h)end)end end,function(e,o)o.close()end,function(p,o)end)end)end)